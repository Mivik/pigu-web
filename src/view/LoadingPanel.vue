<script setup lang="ts">
import { ref, watch, nextTick } from 'vue';

import { vConfetti } from '@neoconfetti/vue';

import { type QueryReturn } from '@/query';

import { MButton, MIcon, MSpinner } from '@/m';

import { mdiAlert } from '@mdi/js';

const props = defineProps<{
  query: QueryReturn;
}>();

const { error, refetch, loading } = props.query;

watch(error, (err) => {
  if (err !== null) console.error(err);
});

const showConfetti = ref(true);
async function boom() {
  showConfetti.value = false;
  await nextTick();
  showConfetti.value = true;
}
</script>

<template>
  <div class="w-full flex py-4 items-center" ref="content">
    <MSpinner v-if="loading" class="w-12 mx-auto" />
    <div v-else-if="error" class="w-full flex items-center flex-col">
      <div>
        <div v-if="showConfetti" v-confetti class="pointer-events-none fixed" />
        <div class="relative text-center">
          <MIcon :icon="mdiAlert" class="h-12 w-12 text-red-600" />
          <h2 class="text-xl font-bold text-red-600">完蛋</h2>
          <div class="absolute left-full pl-4 top-0">
            <div class="relative my-6 rotate-6">
              <span
                class="underline italic can-click select-none relative text-nowrap"
                @click="boom"
              >
                锤爆米维克
              </span>
              <svg viewBox="0 0 63.453537 32.914837" class="absolute -inset-3 pointer-events-none">
                <g transform="translate(-62.167856,-91.557121)">
                  <path
                    style="fill: red"
                    d="m 87.865377,124.38588 c -7.234455,-0.39802 -14.832911,-2.09965 -19.132395,-4.28458 -3.659628,-1.85977 -5.765423,-4.23445 -6.411423,-7.23007 -0.224004,-1.03876 -0.199911,-3.03193 0.05102,-4.22091 0.479137,-2.27028 1.448125,-4.27779 2.959523,-6.13143 1.076406,-1.32014 2.971385,-3.003023 4.562774,-4.052073 0.592212,-0.39038 0.783167,-0.56147 0.783167,-0.70168 0,-0.25992 0.07096,-0.30086 1.354667,-0.78154 0.62865,-0.23539 1.61925,-0.6546 2.201333,-0.93158 2.681742,-1.27608 6.185077,-2.44961 9.631452,-3.22628 8.5793,-1.93344 17.415195,-1.65102 25.251215,0.80711 5.18418,1.62626 10.44661,4.62501 13.17443,7.507323 3.86003,4.07866 4.38338,8.73331 1.47143,13.08673 -1.84951,2.76504 -5.1397,4.95034 -9.90452,6.57845 -0.58209,0.19889 -1.42029,0.53154 -1.86267,0.73922 -2.95388,1.38667 -7.3777,2.32685 -12.615342,2.68108 -3.72741,0.25209 -8.610118,0.32003 -11.514661,0.16023 z m -3.344333,-1.85028 c -6.598602,-1.34895 -13.092026,-3.90299 -16.385738,-6.44496 -1.349749,-1.04169 -2.440585,-2.23146 -3.07458,-3.35344 -0.710339,-1.25708 -1.051776,-2.45769 -1.143756,-4.02182 l -0.0561,-0.95406 -0.147326,0.56739 c -0.393409,1.51513 -0.369472,3.17666 0.06751,4.68595 0.750536,2.59227 2.492436,4.45981 5.482873,5.87833 4.141416,1.96449 8.905483,3.18968 14.96079,3.84751 1.933703,0.21007 2.023271,0.14814 0.296333,-0.2049 z m 15.748006,-0.42312 c 3.28136,-0.27077 7.00754,-0.85949 9.67939,-1.52928 1.4023,-0.35154 1.76228,-0.47695 2.51954,-0.87774 4.03149,-2.13375 6.69365,-5.51751 7.36537,-9.36181 0.1974,-1.12968 0.12423,-2.8689 -0.16777,-3.98833 -0.72795,-2.79062 -2.65967,-5.40337 -5.36129,-7.251403 -3.00925,-2.05845 -6.84623,-3.33008 -12.31817,-4.08239 -6.757562,-0.92907 -14.199292,-0.67916 -21.656076,0.72727 -2.199197,0.41478 -2.909135,0.5806 -3.737123,0.87284 -1.976921,0.69777 -3.774257,1.59472 -5.575437,2.7824 -1.213596,0.800233 -2.847788,2.397243 -3.613484,3.531283 -0.953749,1.41255 -1.559982,2.83567 -1.80776,4.24369 -0.13423,0.76277 -0.06326,2.59145 0.12775,3.29164 0.184959,0.67802 0.794736,1.92202 1.224285,2.49767 1.797948,2.40943 5.468961,4.63596 10.340107,6.27142 4.518351,1.51702 10.378852,2.64049 15.404636,2.95308 1.492481,0.0928 6.06508,0.0443 7.576032,-0.0803 z m 19.5572,-5.88144 c 1.43018,-1.11677 2.59453,-2.55586 3.35363,-4.14495 0.62042,-1.29882 0.85333,-2.28566 0.86083,-3.64744 0.01,-1.74746 -0.40315,-3.11896 -1.39739,-4.64306 -0.97258,-1.4909 -3.27703,-3.5731 -5.46675,-4.939523 -0.72408,-0.45184 -3.1037,-1.73224 -2.69354,-1.44931 1.00121,0.69063 1.61029,1.15337 2.23837,1.70056 2.33022,2.030093 4.04162,4.955543 4.56444,7.802383 0.19243,1.04784 0.19045,3.06168 -0.004,4.04204 -0.41844,2.10987 -1.60552,4.4729 -3.02541,6.02247 -0.27706,0.30235 -0.50374,0.57288 -0.50374,0.60117 0,0.0926 1.37486,-0.79877 2.07354,-1.34434 z"
                  />
                </g>
              </svg>
            </div>
          </div>
        </div>
      </div>
      <div class="text-white/40 text-center">
        <p>遇到了一些问题。</p>
        <p>你或许不知道如何解决问题，但我们知道需要解决谁。</p>
      </div>
      <MButton class="w-20 my-2" @click="refetch">重试</MButton>
      <pre
        class="w-full bg-black/30 lg:w-1/2 h-96 p-4 rounded mx-2 my-4 overflow-scroll text-gray-500"
        >{{ String(error) + '\n\n' + error.stack }}</pre
      >
    </div>
  </div>
</template>
